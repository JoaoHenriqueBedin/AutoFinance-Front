"use client";

import * as React from "react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";

export default function BudgetScreen() {
  // Estados para gerenciamento dos or√ßamentos
  const [orcamentos, setOrcamentos] = React.useState<Orcamento[]>([])
  const [selectedOrcamento, setSelectedOrcamento] = React.useState<Orcamento | null>(null)
  const [loading, setLoading] = React.useState(true)
  const [currentPage, setCurrentPage] = React.useState(0)
  const [totalPages, setTotalPages] = React.useState(0)
  const [totalElements, setTotalElements] = React.useState(0)
  const [isViewDialogOpen, setIsViewDialogOpen] = React.useState(false)
  const [isEditDialogOpen, setIsEditDialogOpen] = React.useState(false)
  const [isCreateDialogOpen, setIsCreateDialogOpen] = React.useState(false)
  const [isRecoverDialogOpen, setIsRecoverDialogOpen] = React.useState(false)

  // Estados para formul√°rios
  const [createForm, setCreateForm] = React.useState({
    cpfCnpj: '',
    placa: '',
    servicoNome: '',
    valorAjustado: ''
  })

  const [editForm, setEditForm] = React.useState({
    cpfCnpj: '',
    placa: '',
    servicoNome: '',
    valorAjustado: ''
  })

  // Fun√ß√£o para carregar or√ßamentos
  const loadOrcamentos = async (page: number = 0) => {
    try {
      setLoading(true)
      const response = await getOrcamentosList(page, 10)
      setOrcamentos(response.content || [])
      setTotalPages(response.totalPages || 0)
      setTotalElements(response.totalElements || 0)
      setCurrentPage(page)
    } catch (error) {
      console.error('Erro ao carregar or√ßamentos:', error)
      toast.error('Erro ao carregar or√ßamentos')
      setOrcamentos([])
    } finally {
      setLoading(false)
    }
  }

  // Carregar or√ßamentos na inicializa√ß√£o
  React.useEffect(() => {
    loadOrcamentos()
  }, [])

  // Handlers para a√ß√µes dos or√ßamentos
  const handleView = (orcamento: Orcamento) => {
    setSelectedOrcamento(orcamento)
    setIsViewDialogOpen(true)
  }

  const handleEdit = (orcamento: Orcamento) => {
    setSelectedOrcamento(orcamento)
    setEditForm({
      cpfCnpj: orcamento.cliente.cpfCnpj,
      placa: orcamento.veiculo.placa,
      servicoNome: orcamento.servico.nome,
      valorAjustado: orcamento.valorAjustado.toString(),
    });
    setIsEditDialogOpen(true);
  };

  const handleDelete = (budgetId: number) => {
    console.log("Excluindo or√ßamento:", budgetId);
  };

  const handleSaveEdit = () => {
    console.log("Salvando edi√ß√£o:", editForm);
    setIsEditDialogOpen(false);
  };

  const handleCreateBudget = () => {
    console.log("Criando novo or√ßamento");
    setIsCreateDialogOpen(false);
  };

  const handleRecoverBudget = () => {
    console.log("Recuperando or√ßamento");
    setIsRecoverDialogOpen(false);
  };

  // Fun√ß√£o para renderizar os bot√µes de a√ß√£o (evita repeti√ß√£o de c√≥digo)
  const renderActionButtons = (budget: any) => (
    <div className="flex gap-1">
      {/* View Button */}
      <Button
        variant="ghost"
        size="sm"
        className="h-8 w-8 p-0 text-blue-600 hover:bg-purple-100"
        onClick={() => handleView(budget)}
      >
        <Eye className="h-4 w-4" />
      </Button>
      {/* Edit Button */}
      <Button
        variant="ghost"
        size="sm"
        className="h-8 w-8 p-0 text-green-600 hover:bg-green-50"
        onClick={() => handleEdit(budget)}
      >
        <Edit className="h-4 w-4" />
      </Button>
      {/* Delete Button */}
      <AlertDialog>
        <AlertDialogTrigger asChild>
          <Button
            variant="ghost"
            size="sm"
            className="h-8 w-8 p-0 text-red-600 hover:bg-red-50"
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        </AlertDialogTrigger>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Confirmar Exclus√£o</AlertDialogTitle>
            <AlertDialogDescription>
              Tem certeza que deseja excluir o or√ßamento de {budget.cliente}?
              Esta a√ß√£o n√£o pode ser desfeita.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => handleDelete(budget.id)}
              className="bg-red-600 hover:bg-red-700"
            >
              Excluir
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );

  return (
    // AJUSTE 1: Padding responsivo para melhor visualiza√ß√£o em telas pequenas.
    <div className="flex-1 p-4 sm:p-6 min-h-screen">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6">
          <h1 className="text-2xl font-semibold text-gray-900 mb-4">
            Or√ßamentos
          </h1>

          {/* Action Buttons */}
          {/* AJUSTE 2: Empilhar bot√µes em telas pequenas (flex-col) e manter lado a lado em telas maiores (sm:flex-row) */}
          <div className="flex flex-col sm:flex-row gap-3 mb-6">
            <Dialog
              open={isCreateDialogOpen}
              onOpenChange={setIsCreateDialogOpen}
            >
              <DialogTrigger asChild>
                <Button className="bg-[#5A6ACF] hover:bg-[#5A6ACF] text-white w-full sm:w-auto">
                  <Plus className="w-4 h-4 mr-2" />
                  Criar novo or√ßamento
                </Button>
              </DialogTrigger>
              <DialogContent className="sm:max-w-[500px]">
                <DialogHeader>
                  <DialogTitle>Criar Novo Or√ßamento</DialogTitle>
                  <DialogDescription>
                    Preencha os dados para criar um novo or√ßamento.
                  </DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                  {/* Formul√°rio de cria√ß√£o (sem altera√ß√µes) */}
                  <div className="grid gap-2">
                    <Label htmlFor="new-cliente">Cliente</Label>
                    <Input id="new-cliente" placeholder="Nome do cliente" />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="new-carro">Carro</Label>
                    <Input id="new-carro" placeholder="Modelo e ano do carro" />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="new-servico">Servi√ßo</Label>
                    <Textarea
                      id="new-servico"
                      placeholder="Descri√ß√£o do servi√ßo"
                    />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="new-valor">Valor</Label>
                    <Input id="new-valor" placeholder="R$ 0,00" />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="new-mecanico">Mec√¢nico</Label>
                    <Select>
                      <SelectTrigger>
                        <SelectValue placeholder="Selecione o mec√¢nico" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="gustavo">Gustavo</SelectItem>
                        <SelectItem value="isabely">Isabely</SelectItem>
                        <SelectItem value="joao">Jo√£o</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <DialogFooter>
                  <Button
                    variant="outline"
                    onClick={() => setIsCreateDialogOpen(false)}
                  >
                    Cancelar
                  </Button>
                  <Button onClick={handleCreateBudget}>Criar Or√ßamento</Button>
                </DialogFooter>
              </DialogContent>
            </Dialog>

            <Dialog
              open={isRecoverDialogOpen}
              onOpenChange={setIsRecoverDialogOpen}
            >
              <DialogTrigger asChild>
                <Button
                  variant="outline"
                  className="border-blue-600 text-blue-600 hover:bg-purple-100 w-full sm:w-auto"
                >
                  <Search className="w-4 h-4 mr-2" />
                  Recuperar or√ßamento
                </Button>
              </DialogTrigger>
              <DialogContent className="sm:max-w-[400px]">
                <DialogHeader>
                  <DialogTitle>Recuperar Or√ßamento</DialogTitle>
                  <DialogDescription>
                    Digite o ID ou c√≥digo do or√ßamento para recuper√°-lo.
                  </DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                  <div className="grid gap-2">
                    <Label htmlFor="recover-id">ID do Or√ßamento</Label>
                    <Input
                      id="recover-id"
                      placeholder="Digite o ID do or√ßamento"
                    />
                  </div>
                </div>
                <DialogFooter>
                  <Button
                    variant="outline"
                    onClick={() => setIsRecoverDialogOpen(false)}
                  >
                    Cancelar
                  </Button>
                  <Button onClick={handleRecoverBudget}>Recuperar</Button>
                </DialogFooter>
              </DialogContent>
            </Dialog>
          </div>

          {/* Table Header */}
          {/* AJUSTE 3: Empilhar a ordena√ß√£o em telas pequenas */}
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
            <span className="text-sm text-gray-600">
              Listagem de or√ßamentos:
            </span>
            <div className="flex items-center gap-2 w-full sm:w-auto">
              <span className="text-sm text-gray-600">Ordenar por:</span>
              <Select defaultValue="latest">
                <SelectTrigger className="w-full sm:w-48">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="latest">√öltimas adicionadas</SelectItem>
                  <SelectItem value="oldest">Mais antigas</SelectItem>
                  <SelectItem value="client">Cliente A-Z</SelectItem>
                  <SelectItem value="value">Maior valor</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </div>

        {/* AJUSTE 4: ESTRUTURA RESPONSIVA PARA A LISTA */}

        {/* üñ•Ô∏è Tabela para Telas M√©dias e Maiores (md em diante) */}
        <div className="hidden md:block bg-white rounded-lg shadow-sm border">
          <Table>
            <TableHeader>
              <TableRow className="bg-purple-100">
                <TableHead className="text-[#707FDD] font-medium">
                  Cliente
                </TableHead>
                <TableHead className="text-[#707FDD] font-medium">
                  Carro
                </TableHead>
                <TableHead className="text-[#707FDD] font-medium">
                  Servi√ßo
                </TableHead>
                <TableHead className="text-[#707FDD] font-medium">
                  Valor (R$)
                </TableHead>
                <TableHead className="text-[#707FDD] font-medium">
                  Mec√¢nico
                </TableHead>
                <TableHead className="text-blue-700 font-medium w-32">
                  A√ß√µes
                </TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {orcamentos.map((orcamento) => (
                <TableRow key={orcamento.id} className="hover:bg-gray-50">
                  <TableCell className="font-medium">
                    {orcamento.cliente.cpfCnpj}
                  </TableCell>
                  <TableCell>{orcamento.veiculo.placa}</TableCell>
                  <TableCell>{budget.servico}</TableCell>
                  <TableCell className="font-medium text-green-600">
                    {budget.valor}
                  </TableCell>
                  <TableCell>{budget.mecanico}</TableCell>
                  <TableCell>{renderActionButtons(budget)}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>

        {/* üì± Lista de Cards para Telas Pequenas (at√© md) */}
        <div className="grid grid-cols-1 gap-4 md:hidden">
          {budgets.map((budget) => (
            <div
              key={budget.id}
              className="bg-white rounded-lg shadow-sm border p-4 flex flex-col gap-3"
            >
              <div className="flex justify-between items-start">
                <div className="flex-grow">
                  <p className="text-sm text-gray-500">Cliente</p>
                  <p className="font-medium text-gray-900">{budget.cliente}</p>
                </div>
                {renderActionButtons(budget)}
              </div>

              <div>
                <p className="text-sm text-gray-500">Carro</p>
                <p className="text-gray-800">{budget.carro}</p>
              </div>

              <div>
                <p className="text-sm text-gray-500">Servi√ßo</p>
                <p className="text-gray-800">{budget.servico}</p>
              </div>

              <div className="flex justify-between items-center mt-2">
                <div>
                  <p className="text-sm text-gray-500">Valor</p>
                  <p className="font-medium text-green-600">{budget.valor}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-500">Mec√¢nico</p>
                  <p className="text-gray-800">{budget.mecanico}</p>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Pagination */}
        <div className="flex justify-center mt-6">
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              className="bg-blue-600 text-white border-blue-600"
            >
              1
            </Button>
            <Button variant="outline" size="sm">
              2
            </Button>
            <Button variant="outline" size="sm">
              3
            </Button>
            <Button variant="outline" size="sm">
              &gt;
            </Button>
          </div>
        </div>

        {/* View Dialog (sem altera√ß√µes) */}
        <Dialog open={isViewDialogOpen} onOpenChange={setIsViewDialogOpen}>
          <DialogContent className="sm:max-w-[500px]">
            <DialogHeader>
              <DialogTitle>Visualizar Or√ßamento</DialogTitle>
              <DialogDescription>
                Detalhes do or√ßamento selecionado.
              </DialogDescription>
            </DialogHeader>
            {selectedBudget && (
              <div className="grid gap-4 py-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label className="text-sm font-medium text-gray-500">
                      Cliente
                    </Label>
                    <p className="text-sm">{selectedBudget.cliente}</p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-gray-500">
                      Carro
                    </Label>
                    <p className="text-sm">{selectedBudget.carro}</p>
                  </div>
                </div>
                <div>
                  <Label className="text-sm font-medium text-gray-500">
                    Servi√ßo
                  </Label>
                  <p className="text-sm">{selectedBudget.servico}</p>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label className="text-sm font-medium text-gray-500">
                      Valor
                    </Label>
                    <p className="text-sm font-medium text-green-600">
                      {selectedBudget.valor}
                    </p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-gray-500">
                      Mec√¢nico
                    </Label>
                    <p className="text-sm">{selectedBudget.mecanico}</p>
                  </div>
                </div>
              </div>
            )}
            <DialogFooter>
              <Button onClick={() => setIsViewDialogOpen(false)}>Fechar</Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Edit Dialog (sem altera√ß√µes) */}
        <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
          <DialogContent className="sm:max-w-[500px]">
            <DialogHeader>
              <DialogTitle>Editar Or√ßamento</DialogTitle>
              <DialogDescription>
                Fa√ßa as altera√ß√µes necess√°rias no or√ßamento.
              </DialogDescription>
            </DialogHeader>
            <div className="grid gap-4 py-4">
              <div className="grid gap-2">
                <Label htmlFor="edit-cliente">Cliente</Label>
                <Input
                  id="edit-cliente"
                  value={editForm.cliente}
                  onChange={(e) =>
                    setEditForm({ ...editForm, cliente: e.target.value })
                  }
                />
              </div>
              <div className="grid gap-2">
                <Label htmlFor="edit-carro">Carro</Label>
                <Input
                  id="edit-carro"
                  value={editForm.carro}
                  onChange={(e) =>
                    setEditForm({ ...editForm, carro: e.target.value })
                  }
                />
              </div>
              <div className="grid gap-2">
                <Label htmlFor="edit-servico">Servi√ßo</Label>
                <Textarea
                  id="edit-servico"
                  value={editForm.servico}
                  onChange={(e) =>
                    setEditForm({ ...editForm, servico: e.target.value })
                  }
                />
              </div>
              <div className="grid gap-2">
                <Label htmlFor="edit-valor">Valor</Label>
                <Input
                  id="edit-valor"
                  value={editForm.valor}
                  onChange={(e) =>
                    setEditForm({ ...editForm, valor: e.target.value })
                  }
                />
              </div>
              <div className="grid gap-2">
                <Label htmlFor="edit-mecanico">Mec√¢nico</Label>
                <Select
                  value={editForm.mecanico}
                  onValueChange={(value) =>
                    setEditForm({ ...editForm, mecanico: value })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="Gustavo">Gustavo</SelectItem>
                    <SelectItem value="Isabely">Isabely</SelectItem>
                    <SelectItem value="Jo√£o">Jo√£o</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => setIsEditDialogOpen(false)}
              >
                Cancelar
              </Button>
              <Button onClick={handleSaveEdit}>Salvar Altera√ß√µes</Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}
